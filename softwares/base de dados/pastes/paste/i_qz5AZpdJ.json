{
 "espireDate": "N",
 "format": "text",
 "jSonReasons": [
  "re_php",
  "lg_en"
 ],
 "key": "qz5AZpdJ",
 "pasteDate": "Feb 20, 2018, 3:48:38 PM",
 "relevancy": 0.0,
 "relevant": false,
 "text": "Index: app/models/user.rb\n===================================================================\n--- app/models/user.rb  (revision 1978)\n+++ app/models/user.rb  (working copy)\n@@ -21,7 +21,7 @@\n   # first user becomes admin automatically\n   before_create { |u| u.admin = true if User.count == 0 }\n \n-  attr_protected :admin, :posts_count, :login, :created_at, :updated_at, :last_login_at, :topics_count\n+  attr_protected :admin, :posts_count, :login, :created_at, :updated_at, :last_login_at, :topics_count, :activated\n \n   def self.currently_online\n     user_ids = Session.find(:all, :select => \"user_id\", :conditions => [\"user_id is NOT NULL and sessions.updated_at > ?\", Time.now.utc-5.minutes]).map(&:user_id).uniq\n@@ -39,5 +39,10 @@\n   def moderator_of?(forum)\n     moderatorships.count(:all, :conditions => ['forum_id = ?', (forum.is_a?(Forum) ? forum.id : forum)]) == 1\n   end\n+  \n+  def activate\n+    self.activated = true\n+    save!\n+  end\n \n end\nIndex: app/controllers/users_controller.rb\n===================================================================\n--- app/controllers/users_controller.rb (revision 1978)\n+++ app/controllers/users_controller.rb (working copy)\n@@ -17,11 +17,20 @@\n   def create\n     @user = User.new(params[:user])\n     @user.login = params[:user][:login]\n+    @user.reset_login_key!\n     @user.save!\n+    UserMailer.deliver_signup(@user, request.domain)\n     flash[:notice]=\"You have signed up, now you need to login for the first time.\"\n     redirect_to login_path\n   end\n   \n+  def activate\n+    user = User.find_by_login_key(params[:key])\n+    user.activate\n+    flash[:notice]=\"Signup complete, you may now login.\"\n+    redirect_to login_path\n+  end\n+  \n   def update\n     @user.attributes = params[:user]\n     # temp fix to let people with dumb usernames change them\nIndex: config/routes.rb\n===================================================================\n--- config/routes.rb    (revision 1978)\n+++ config/routes.rb    (working copy)\n@@ -21,6 +21,8 @@\n \n   map.signup '/signup',     :controller => 'users',    :action => 'new'\n   map.settings '/settings', :controller => 'users',    :action => 'edit'\n+  map.activate '/activate/:key', :controller => 'users', :action => 'activate'\n   map.login  '/login',      :controller => 'sessions', :action => 'new'\n   map.logout '/logout',     :controller => 'sessions', :action => 'destroy'\n+  \n end\nIndex: db/schema.rb\n===================================================================\n--- db/schema.rb        (revision 1978)\n+++ db/schema.rb        (working copy)\n@@ -2,7 +2,7 @@\n # migrations feature of ActiveRecord to incrementally modify your database, and\n # then regenerate this schema definition.\n \n-ActiveRecord::Schema.define(:version => 31) do\n+ActiveRecord::Schema.define(:version => 32) do\n \n   create_table \"forums\", :force => true do |t|\n     t.column \"name\",         :string\n@@ -66,6 +66,7 @@\n     t.column \"website\",              :string\n     t.column \"login_key\",            :string\n     t.column \"login_key_expires_at\", :datetime\n+    t.column \"activated\",            :boolean,  :default => false\n   end\n \n end",
 "title": ""
}