{
 "espireDate": "N",
 "format": "text",
 "jSonReasons": [
  "kw_op",
  "re_sql",
  "re_skuid",
  "lg_en"
 ],
 "key": "fvGxuGwx",
 "pasteDate": "Feb 19, 2018, 2:21:05 PM",
 "relevancy": -1.0,
 "relevant": false,
 "text": "trigger trg_AutoCaseCreate on Opportunity (after insert, after update) {\n\n//Create a list of Opportunities\nList<Opportunity> ClosedWonOpps = new List<Opportunity>();\n\n//For Opportunities that have triggered the Code and are Closed Won and have a Line Item check list is not Empty\nfor (Opportunity opp : trigger.new){\n    if (opp.StageName == 'Closed Won' && opp.HasOpportunityLineItem == true){\n    closedWonOpps.add(opp);\n    }\n}\n\n if (!closedWonOpps.isEmpty())\n\n\n\n//Create a List of OpportunityLine Item Values to use on Created Case\n     {\n       List<OpportunityLineItem> olis = [SELECT UnitPrice, AccountId__c, Quantity, Opportunity_Close_Date__c, OpportunityId, PricebookEntry.Product2Id, TotalPrice, Name, PricebookEntry.Product2.Name, Description, Country__c, CurrencyIsoCode\n                                       FROM OpportunityLineItem WHERE OpportunityId in :ClosedWonOpps];           \n\n\n//Create a List of Cases to Insert            \nList<Case> caToInsert = new list<Case>();        \n\n//Match oli variable to Values mapped in Olis List    \nfor (OpportunityLineItem oli : olis){                 \n\n   //Check if following OpportunityLineItem was added to olis List \n if(oli.PricebookEntry.Product2.Name == 'Change of Company Details')\n {\n\n//if OpLineItem exists on Op, create a new case\n    Case IPCase = new Case();   \n\n//THIS IS WHERE CODE IS FAILING\n     List<Case> FindParentCase = [SELECT Id, AccountID FROM Case WHERE Country__c = :oli.country__C AND AccountId = :oli.AccountID__c AND RecordTypeId = '01220000000FpC8' order by createdDate DESC limit 1]; \n        for (Case fpc : FindParentCase){\n\n\n              if(fpc.id !=null){\n        IpCase.ParentId = fpc.Id;\n              }else{\n                  IPCase.ParentId = null;}\n\n //CODE FAIL ENDS\n\n\n\n        IpCase.RecordTypeId = '01220000000Fr0I';\n        IpCase.AccountId = oli.AccountId__c;\n        IPCase.Country__c = oli.Country__c;\n        IPCase.CurrencyIsoCode = oli.CurrencyIsoCode;\n        IPCase.Related_Opportunity__c =  oli.OpportunityId;\n        IPCase.Subject = oli.AccountId__c + ' - ' + oli.PricebookEntry.Product2.Name + ' - ' + oli.Country__c;\n        IPCase.Type = 'Change of Company Details';\n        IPCase.origin = 'Client';\n        IPCase.Priority = 'Medium';\n        IPCase.Status = 'New Service';\n        IPCase.Due_Date__c = oli.Opportunity_Close_Date__c;\n        IPCase.Amount__c = oli.TotalPrice;\n\n\n     //Add new case to Case List ready to insert at the end\n   caToInsert.add(Ipcase);    \n }\n }\n\nif(oli.PricebookEntry.Product2.Name == 'Compliance Hours')\n{\n    Case IPCase1 = new Case();\n\n\n        IpCase1.RecordTypeId = '01220000000Fr0I';\n        IPCase1.Country__c = oli.Country__c;\n        IPCase1.CurrencyIsoCode = oli.CurrencyIsoCode;\n        IPCase1.Related_Opportunity__c =  oli.OpportunityId;\n        IPCase1.Subject = oli.Name;\n        IPCase1.Type = 'Compliance Hours';\n        IPCase1.origin = 'Client';\n        IPCase1.Priority = 'Medium';\n        IPCase1.Status = 'New Service';\n        IPCase1.Due_Date__c = oli.Opportunity_Close_Date__c;\n        IPCase1.Amount__c = oli.TotalPrice;\n\n   caToInsert.add(Ipcase1);    \n}\n\nif(oli.PricebookEntry.Product2.Name == 'De-Registration')\n{\n    Case IPCase2 = new Case();\n\n        IpCase2.RecordTypeId = '01220000000Fr0I';\n        IPCase2.Country__c = oli.Country__c;\n        IPCase2.CurrencyIsoCode = oli.CurrencyIsoCode;\n        IPCase2.Related_Opportunity__c =  oli.OpportunityId;\n        IPCase2.Subject = oli.Name;\n        IPCase2.Type = 'De-Registration';\n        IPCase2.origin = 'Client';\n        IPCase2.Priority = 'Medium';\n        IPCase2.Status = 'New Service';\n        IPCase2.Due_Date__c = oli.Opportunity_Close_Date__c;\n        IPCase2.Amount__c = oli.TotalPrice;\n\n   caToInsert.add(Ipcase2);      \n}\n}\n    insert caToInsert;         \n     }         \n }",
 "title": ""
}