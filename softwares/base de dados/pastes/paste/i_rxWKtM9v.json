{
 "espireDate": "N",
 "format": "text",
 "jSonReasons": [
  "lg_en"
 ],
 "key": "rxWKtM9v",
 "pasteDate": "Feb 12, 2018, 7:40:38 AM",
 "relevancy": 3.0,
 "relevant": false,
 "text": "import ui\nimport player\nimport mouseModule\nimport net\nimport app\nimport snd\nimport item\nimport player\nimport chat\nimport grp\nimport uiRefine\nimport uiAttachMetin\nimport uiPickMoney\nimport uiCommon\nimport uiPrivateShopBuilder #   ItemMove \nimport locale\nimport constInfo\nimport ime\n\nITEM_FLAG_APPLICABLE = 1 << 14\n\nclass InventoryWindow(ui.ScriptWindow):\n\n\tUSE_TYPE_TUPLE = (\"USE_CLEAN_SOCKET\", \"USE_CHANGE_ATTRIBUTE\", \"USE_ADD_ATTRIBUTE\", \"USE_ADD_ATTRIBUTE2\", \"USE_ADD_ACCESSORY_SOCKET\", \"USE_PUT_INTO_ACCESSORY_SOCKET\")\n\n\tdef __init__(self):\n\t\tui.ScriptWindow.__init__(self)\n\t\tself.questionDialog = None\n\t\tself.tooltipItem = None\n\t\tself.sellingSlotNumber = -1\n\t\tself.isLoaded = 0\n\n\t\tself.__LoadWindow()\n\n\tdef __del__(self):\n\t\tui.ScriptWindow.__del__(self)\n\n\tdef Show(self):\n\t\tself.__LoadWindow()\n\n\t\tui.ScriptWindow.Show(self)\n\n\n\tdef __LoadWindow(self):\n\t\tif self.isLoaded == 1:\n\t\t\treturn\n\n\t\tself.isLoaded = 1\n\n\t\ttry:\n\t\t\tpyScrLoader = ui.PythonScriptLoader()\n\t\t\tpyScrLoader.LoadScriptFile(self, \"UIScript/InventoryWindow.py\")\n\t\texcept:\n\t\t\timport exception\n\t\t\texception.Abort(\"InventoryWindow.LoadWindow.LoadObject\")\n\n\t\ttry:\n\t\t\twndItem = self.GetChild(\"ItemSlot\")\n\t\t\twndEquip = self.GetChild(\"EquipmentSlot\")\n\t\t\tself.GetChild(\"TitleBar\").SetCloseEvent(ui.__mem_func__(self.Close))\n\t\t\tself.wndMoney = self.GetChild(\"Money\")\n\t\t\tself.wndMoneySlot = self.GetChild(\"Money_Slot\")\n\n\t\t\tself.inventoryTab = []\n\t\t\tself.inventoryTab.append(self.GetChild(\"Inventory_Tab_01\"))\n\t\t\tself.inventoryTab.append(self.GetChild(\"Inventory_Tab_02\"))\n\n\t\t\tself.equipmentTab = []\n\t\t\tself.equipmentTab.append(self.GetChild(\"Equipment_Tab_01\"))\n\t\t\tself.equipmentTab.append(self.GetChild(\"Equipment_Tab_02\"))\n\n\t\texcept:\n\t\t\timport exception\n\t\t\texception.Abort(\"InventoryWindow.LoadWindow.BindObject\")\n\n\t\t## Item\n\t\twndItem.SetSelectEmptySlotEvent(ui.__mem_func__(self.SelectEmptySlot))\n\t\twndItem.SetSelectItemSlotEvent(ui.__mem_func__(self.SelectItemSlot))\n\t\twndItem.SetUnselectItemSlotEvent(ui.__mem_func__(self.UseItemSlot))\n\t\twndItem.SetUseSlotEvent(ui.__mem_func__(self.UseItemSlot))\n\t\twndItem.SetOverInItemEvent(ui.__mem_func__(self.OverInItem))\n\t\twndItem.SetOverOutItemEvent(ui.__mem_func__(self.OverOutItem))\n\n\t\t## Equipment\n\t\twndEquip.SetSelectEmptySlotEvent(ui.__mem_func__(self.SelectEmptySlot))\n\t\twndEquip.SetSelectItemSlotEvent(ui.__mem_func__(self.SelectItemSlot))\n\t\twndEquip.SetUnselectItemSlotEvent(ui.__mem_func__(self.UseItemSlot))\n\t\twndEquip.SetUseSlotEvent(ui.__mem_func__(self.UseItemSlot))\n\t\twndEquip.SetOverInItemEvent(ui.__mem_func__(self.OverInItem))\n\t\twndEquip.SetOverOutItemEvent(ui.__mem_func__(self.OverOutItem))\n\n\t\t## PickMoneyDialog\n\t\tdlgPickMoney = uiPickMoney.PickMoneyDialog()\n\t\tdlgPickMoney.LoadDialog()\n\t\tdlgPickMoney.Hide()\n\n\t\t## RefineDialog\n\t\tself.refineDialog = uiRefine.RefineDialog()\n\t\tself.refineDialog.Hide()\n\n\t\t## AttachMetinDialog\n\t\tself.attachMetinDialog = uiAttachMetin.AttachMetinDialog()\n\t\tself.attachMetinDialog.Hide()\n\n\t\t## MoneySlot\n\t\tself.wndMoneySlot.SetEvent(ui.__mem_func__(self.OpenPickMoneyDialog))\n\n\t\tself.inventoryTab[0].SetEvent(lambda arg=0: self.SetInventoryPage(arg))\n\t\tself.inventoryTab[1].SetEvent(lambda arg=1: self.SetInventoryPage(arg))\n\t\tself.inventoryTab[0].Down()\n\n\t\tself.equipmentTab[0].SetEvent(lambda arg=0: self.SetEquipmentPage(arg))\n\t\tself.equipmentTab[1].SetEvent(lambda arg=1: self.SetEquipmentPage(arg))\n\t\tself.equipmentTab[0].Down()\n\t\tself.equipmentTab[0].Hide()\n\t\tself.equipmentTab[1].Hide()\n\n\t\tself.wndItem = wndItem\n\t\tself.wndEquip = wndEquip\n\t\tself.dlgPickMoney = dlgPickMoney\n\n\t\t#####\n\n\t\t## Refresh\n\t\tself.SetInventoryPage(0)\n\t\tself.SetEquipmentPage(0)\n\t\tself.RefreshItemSlot()\n\t\tself.RefreshStatus()\n\n\tdef Destroy(self):\n\t\tself.ClearDictionary()\n\n\t\tself.dlgPickMoney.Destroy()\n\t\tself.dlgPickMoney = 0\n\n\t\tself.refineDialog.Destroy()\n\t\tself.refineDialog = 0\n\n\t\tself.attachMetinDialog.Destroy()\n\t\tself.attachMetinDialog = 0\n\n\t\tself.tooltipItem = None\n\t\tself.wndItem = 0\n\t\tself.wndEquip = 0\n\t\tself.dlgPickMoney = 0\n\t\tself.wndMoney = 0\n\t\tself.wndMoneySlot = 0\n\t\tself.questionDialog = None\n\n\t\tself.inventoryTab = []\n\t\tself.equipmentTab = []\n\n\tdef Close(self):\n\t\tif None != self.tooltipItem:\n\t\t\tself.tooltipItem.HideToolTip()\n\n\t\tself.OnCloseQuestionDialog()\n\t\tself.dlgPickMoney.Close()\n\t\tself.Hide()\n\n\tdef SetInventoryPage(self, page):\n\t\tself.inventoryPageIndex = page\n\t\tself.inventoryTab[1-page].SetUp()\n\t\tself.RefreshBagSlotWindow()\n\n\tdef SetEquipmentPage(self, page):\n\t\tself.equipmentPageIndex = page\n\t\tself.equipmentTab[1-page].SetUp()\n\t\tself.RefreshEquipSlotWindow()\n\n\tdef OpenPickMoneyDialog(self):\n\n\t\tif mouseModule.mouseController.isAttached():\n\n\t\t\tattachedSlotPos = mouseModule.mouseController.GetAttachedSlotNumber()\n\t\t\tif player.SLOT_TYPE_SAFEBOX == mouseModule.mouseController.GetAttachedType():\n\n\t\t\t\tif player.ITEM_MONEY == mouseModule.mouseController.GetAttachedItemIndex():\n\t\t\t\t\tnet.SendSafeboxWithdrawMoneyPacket(mouseModule.mouseController.GetAttachedItemCount())\n\t\t\t\t\tsnd.PlaySound(\"sound/ui/money.wav\")\n\n\t\t\tmouseModule.mouseController.DeattachObject()\n\n\t\telse:\n\t\t\tcurMoney = player.GetElk()\n\n\t\t\tif curMoney <= 0:\n\t\t\t\treturn\n\n\t\t\tself.dlgPickMoney.SetTitleName(locale.PICK_MONEY_TITLE)\n\t\t\tself.dlgPickMoney.SetAcceptEvent(ui.__mem_func__(self.OnPickMoney))\n\t\t\tself.dlgPickMoney.Open(curMoney)\n\t\t\tself.dlgPickMoney.SetMax(7) #  990000   \n\n\tdef OnPickMoney(self, money):\n\t\tmouseModule.mouseController.AttachMoney(self, player.SLOT_TYPE_INVENTORY, money)\n\n\tdef OnPickItem(self, count):\n\t\titemSlotIndex = self.dlgPickMoney.itemGlobalSlotIndex\n\t\tselectedItemVNum = player.GetItemIndex(itemSlotIndex)\n\t\tmouseModule.mouseController.AttachObject(self, player.SLOT_TYPE_INVENTORY, itemSlotIndex, selectedItemVNum, count)\n\n\tdef __InventoryLocalSlotPosToGlobalSlotPos(self, local):\n\n\t\tif player.IsEquipmentSlot(local):\n\t\t\treturn local\n\n\t\treturn self.inventoryPageIndex*player.INVENTORY_PAGE_SIZE + local\n\n\tdef RefreshBagSlotWindow(self):\n\t\tgetItemVNum=player.GetItemIndex\n\t\tgetItemCount=player.GetItemCount\n\t\tsetItemVNum=self.wndItem.SetItemSlot\n\t\tfor i in xrange(player.INVENTORY_PAGE_SIZE):\n\t\t\tslotNumber = self.__InventoryLocalSlotPosToGlobalSlotPos(i)\n\t\t\titemCount = getItemCount(slotNumber)\n\t\t\tif itemCount <= 1:\n\t\t\t\titemCount = 0\n\t\t\tsetItemVNum(i, getItemVNum(slotNumber), itemCount)\n\n\t\tself.wndItem.RefreshSlot()\n\n\tdef RefreshEquipSlotWindow(self):\n\t\tgetItemVNum=player.GetItemIndex\n\t\tgetItemCount=player.GetItemCount\n\t\tsetItemVNum=self.wndEquip.SetItemSlot\n\t\tfor i in xrange(player.EQUIPMENT_PAGE_COUNT):\n\t\t\tslotNumber = player.EQUIPMENT_SLOT_START + i\n\t\t\titemCount = getItemCount(slotNumber)\n\t\t\tif itemCount <= 1:\n\t\t\t\titemCount = 0\n\t\t\tsetItemVNum(slotNumber, getItemVNum(slotNumber), itemCount)\n\n\t\tself.wndEquip.RefreshSlot()\n\n\tdef RefreshItemSlot(self):\n\t\tself.RefreshBagSlotWindow()\n\t\tself.RefreshEquipSlotWindow()\n\n\tdef RefreshStatus(self):\n\t\tmoney = player.GetElk()\n\t\tif money <=  100000000 :\n\t\t\tself . wndMoney . SetFontColor ( 0 ,  102 ,  255 )\t\t\n\t\telif money >=  100000001  and money <=  1000000000 :\t\t\n\t\t\tself . wndMoney . SetFontColor ( 1.0 ,  0.6 ,  0.2 )\t\t\n\t\telif money >=  1000000001  and money <=  1500000000 :\t\t\n\t\t\tself . wndMoney . SetFontColor ( 1.0 ,  1.0 ,  0.2 )\t\t\n\t\telif money >=  1500000001 :\t\t\n\t\t\tself . wndMoney . SetFontColor ( 0.6 ,  1.0 ,  0.2 )\n\t\tself.wndMoney.SetText(localeInfo.NumberToMoneyString(money))\n\n\tdef SetItemToolTip(self, tooltipItem):\n\t\tself.tooltipItem = tooltipItem\n\n\tdef SellItem(self):\n\n\t\tnet.SendShopSellPacketNew(self.sellingSlotNumber, self.questionDialog.count)\n\t\tsnd.PlaySound(\"sound/ui/money.wav\")\n\t\tself.OnCloseQuestionDialog()\n\n\tdef OnDetachMetinFromItem(self):\n\t\tif None == self.questionDialog:\n\t\t\treturn\n\t\t\t\n\t\t#net.SendItemUseToItemPacket(self.questionDialog.sourcePos, self.questionDialog.targetPos)\t\t\n\t\tself.__SendUseItemToItemPacket(self.questionDialog.sourcePos, self.questionDialog.targetPos)\n\t\tself.OnCloseQuestionDialog()\n\n\tdef OnCloseQuestionDialog(self):\n\t\tif self.questionDialog:\n\t\t\tself.questionDialog.Close()\n\n\t\tself.questionDialog = None\n\n\t## Slot Event\n\tdef SelectEmptySlot(self, selectedSlotPos):\n\n\t\tselectedSlotPos = self.__InventoryLocalSlotPosToGlobalSlotPos(selectedSlotPos)\n\n\t\tif mouseModule.mouseController.isAttached():\n\n\t\t\tattachedSlotType = mouseModule.mouseController.GetAttachedType()\n\t\t\tattachedSlotPos = mouseModule.mouseController.GetAttachedSlotNumber()\n\t\t\tattachedItemCount = mouseModule.mouseController.GetAttachedItemCount()\n\t\t\tattachedItemIndex = mouseModule.mouseController.GetAttachedItemIndex()\n\n\t\t\tif player.SLOT_TYPE_INVENTORY == attachedSlotType:\n\t\t\t\titemCount = player.GetItemCount(attachedSlotPos)\n\t\t\t\tattachedCount = mouseModule.mouseController.GetAttachedItemCount()\n\t\t\t\tself.__SendMoveItemPacket(attachedSlotPos, selectedSlotPos, attachedCount)\n\t\t\t\t#net.SendItemMovePacket(attachedSlotPos, selectedSlotPos, attachedCount)\n\n\t\t\t\tif item.IsRefineScroll(attachedItemIndex):\n\t\t\t\t\tself.wndItem.SetUseMode(FALSE)\n\n\t\t\telif player.SLOT_TYPE_PRIVATE_SHOP == attachedSlotType:\n\t\t\t\tmouseModule.mouseController.RunCallBack(\"INVENTORY\")\n\n\t\t\telif player.SLOT_TYPE_SHOP == attachedSlotType:\n\t\t\t\tnet.SendShopBuyPacket(attachedSlotPos)\n\n\t\t\telif player.SLOT_TYPE_SAFEBOX == attachedSlotType:\n\n\t\t\t\tif player.ITEM_MONEY == attachedItemIndex:\n\t\t\t\t\tnet.SendSafeboxWithdrawMoneyPacket(mouseModule.mouseController.GetAttachedItemCount())\n\t\t\t\t\tsnd.PlaySound(\"sound/ui/money.wav\")\n\n\t\t\t\telse:\n\t\t\t\t\tnet.SendSafeboxCheckoutPacket(attachedSlotPos, selectedSlotPos)\n\n\t\t\telif player.SLOT_TYPE_MALL == attachedSlotType:\n\t\t\t\tnet.SendMallCheckoutPacket(attachedSlotPos, selectedSlotPos)\n\n\t\t\tmouseModule.mouseController.DeattachObject()\n\n\tdef SelectItemSlot(self, itemSlotIndex):\n\n\t\titemSlotIndex = self.__InventoryLocalSlotPosToGlobalSlotPos(itemSlotIndex)\n\n\t\tif mouseModule.mouseController.isAttached():\n\t\t\tattachedSlotType = mouseModule.mouseController.GetAttachedType()\n\t\t\tattachedSlotPos = mouseModule.mouseController.GetAttachedSlotNumber()\n\t\t\tattachedItemVID = mouseModule.mouseController.GetAttachedItemIndex()\n\n\t\t\tif player.SLOT_TYPE_INVENTORY == attachedSlotType:\n\t\t\t\tself.__DropSrcItemToDestItemInInventory(attachedItemVID, attachedSlotPos, itemSlotIndex)\n\n\t\t\tmouseModule.mouseController.DeattachObject()\n\n\t\telse:\n\n\t\t\tcurCursorNum = app.GetCursor()\n\t\t\tif app.SELL == curCursorNum:\n\t\t\t\tself.__SellItem(itemSlotIndex)\n\t\t\t\t\n\t\t\telif app.BUY == curCursorNum:\n\t\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.SHOP_BUY_INFO)\n\n\t\t\telif app.IsPressed(app.DIK_LALT):\n\t\t\t\tlink = player.GetItemLink(itemSlotIndex)\n\t\t\t\time.PasteString(link)\n\n\t\t\telif app.IsPressed(app.DIK_LSHIFT):\n\t\t\t\titemCount = player.GetItemCount(itemSlotIndex)\n\t\t\t\t\n\t\t\t\tif itemCount > 1:\n\t\t\t\t\tself.dlgPickMoney.SetTitleName(locale.PICK_ITEM_TITLE)\n\t\t\t\t\tself.dlgPickMoney.SetAcceptEvent(ui.__mem_func__(self.OnPickItem))\n\t\t\t\t\tself.dlgPickMoney.Open(itemCount)\n\t\t\t\t\tself.dlgPickMoney.itemGlobalSlotIndex = itemSlotIndex\n\t\t\t\t#else:\n\t\t\t\t\t#selectedItemVNum = player.GetItemIndex(itemSlotIndex)\n\t\t\t\t\t#mouseModule.mouseController.AttachObject(self, player.SLOT_TYPE_INVENTORY, itemSlotIndex, selectedItemVNum)\n\n\t\t\telif app.IsPressed(app.DIK_LCONTROL):\n\t\t\t\titemIndex = player.GetItemIndex(itemSlotIndex)\n\n\t\t\t\tif TRUE == item.CanAddToQuickSlotItem(itemIndex):\n\t\t\t\t\tplayer.RequestAddToEmptyLocalQuickSlot(player.SLOT_TYPE_INVENTORY, itemSlotIndex)\n\t\t\t\telse:\n\t\t\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.QUICKSLOT_REGISTER_DISABLE_ITEM)\n\n\t\t\telse:\n\t\t\t\tselectedItemVNum = player.GetItemIndex(itemSlotIndex)\n\t\t\t\titemCount = player.GetItemCount(itemSlotIndex)\n\t\t\t\tmouseModule.mouseController.AttachObject(self, player.SLOT_TYPE_INVENTORY, itemSlotIndex, selectedItemVNum, itemCount)\n\t\t\t\t\n\t\t\t\tif self.__IsUsableItemToItem(selectedItemVNum, itemSlotIndex):\t\t\t\t\n\t\t\t\t\tself.wndItem.SetUseMode(TRUE)\n\t\t\t\telse:\t\t\t\t\t\n\t\t\t\t\tself.wndItem.SetUseMode(FALSE)\n\n\t\t\t\tsnd.PlaySound(\"sound/ui/pick.wav\")\n\n\tdef __DropSrcItemToDestItemInInventory(self, srcItemVID, srcItemSlotPos, dstItemSlotPos):\n\t\tif srcItemSlotPos == dstItemSlotPos:\n\t\t\treturn\n\t\t\t\t\t\n\t\tif item.IsRefineScroll(srcItemVID):\n\t\t\tself.RefineItem(srcItemSlotPos, dstItemSlotPos)\n\t\t\tself.wndItem.SetUseMode(FALSE)\n\n\t\telif item.IsMetin(srcItemVID):\n\t\t\tself.AttachMetinToItem(srcItemSlotPos, dstItemSlotPos)\n\n\t\telif item.IsDetachScroll(srcItemVID):\n\t\t\tself.DetachMetinFromItem(srcItemSlotPos, dstItemSlotPos)\n\n\t\telif item.IsKey(srcItemVID):\n\t\t\tself.__SendUseItemToItemPacket(srcItemSlotPos, dstItemSlotPos)\t\t\t\n\n\t\telif (player.GetItemFlags(srcItemSlotPos) & ITEM_FLAG_APPLICABLE) == ITEM_FLAG_APPLICABLE:\n\t\t\tself.__SendUseItemToItemPacket(srcItemSlotPos, dstItemSlotPos)\n\n\t\telif item.GetUseType(srcItemVID) in self.USE_TYPE_TUPLE:\n\t\t\tself.__SendUseItemToItemPacket(srcItemSlotPos, dstItemSlotPos)\t\t\t\n\n\t\telse:\n\t\t\t#snd.PlaySound(\"sound/ui/drop.wav\")\n\n\t\t\t##          - [levites]\n\t\t\tif player.IsEquipmentSlot(dstItemSlotPos):\n\n\t\t\t\t##    \n\t\t\t\tif item.IsEquipmentVID(srcItemVID):\n\t\t\t\t\tself.__UseItem(srcItemSlotPos)\n\n\t\t\telse:\n\t\t\t\tself.__SendMoveItemPacket(srcItemSlotPos, dstItemSlotPos, 0)\n\t\t\t\t#net.SendItemMovePacket(srcItemSlotPos, dstItemSlotPos, 0)\n\n\tdef __SellItem(self, itemSlotPos):\n\t\tif not player.IsEquipmentSlot(itemSlotPos):\n\t\t\tself.sellingSlotNumber = itemSlotPos\n\t\t\titemIndex = player.GetItemIndex(itemSlotPos)\n\t\t\titemCount = player.GetItemCount(itemSlotPos)\n\n\t\t\titem.SelectItem(itemIndex)\n\t\t\titemPrice = item.GetISellItemPrice()\n\n\t\t\tif item.Is1GoldItem():\n\t\t\t\titemPrice = itemCount / itemPrice / 5\n\t\t\telse:\n\t\t\t\titemPrice = itemPrice * itemCount / 5\n\n\t\t\titem.GetItemName(itemIndex)\n\t\t\titemName = item.GetItemName()\n\n\t\t\tself.questionDialog = uiCommon.QuestionDialog()\n\t\t\tself.questionDialog.SetText(locale.DO_YOU_SELL_ITEM(itemName, itemCount, itemPrice))\n\t\t\tself.questionDialog.SetAcceptEvent(ui.__mem_func__(self.SellItem))\n\t\t\tself.questionDialog.SetCancelEvent(ui.__mem_func__(self.OnCloseQuestionDialog))\n\t\t\tself.questionDialog.Open()\n\t\t\tself.questionDialog.count = itemCount\n\n\tdef RefineItem(self, scrollSlotPos, targetSlotPos):\n\n\t\tscrollIndex = player.GetItemIndex(scrollSlotPos)\n\t\ttargetIndex = player.GetItemIndex(targetSlotPos)\n\n\t\tif player.REFINE_OK != player.CanRefine(scrollIndex, targetSlotPos):\n\t\t\treturn\n\n\t\t###########################################################\n\t\tself.__SendUseItemToItemPacket(scrollSlotPos, targetSlotPos)\n\t\t#net.SendItemUseToItemPacket(scrollSlotPos, targetSlotPos)\n\t\treturn\n\t\t###########################################################\n\n\t\t###########################################################\n\t\t#net.SendRequestRefineInfoPacket(targetSlotPos)\n\t\t#return\n\t\t###########################################################\n\n\t\tresult = player.CanRefine(scrollIndex, targetSlotPos)\n\n\t\tif player.REFINE_ALREADY_MAX_SOCKET_COUNT == result:\n\t\t\t#snd.PlaySound(\"sound/ui/jaeryun_fail.wav\")\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_NO_MORE_SOCKET)\n\n\t\telif player.REFINE_NEED_MORE_GOOD_SCROLL == result:\n\t\t\t#snd.PlaySound(\"sound/ui/jaeryun_fail.wav\")\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_NEED_BETTER_SCROLL)\n\n\t\telif player.REFINE_CANT_MAKE_SOCKET_ITEM == result:\n\t\t\t#snd.PlaySound(\"sound/ui/jaeryun_fail.wav\")\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_SOCKET_DISABLE_ITEM)\n\n\t\telif player.REFINE_NOT_NEXT_GRADE_ITEM == result:\n\t\t\t#snd.PlaySound(\"sound/ui/jaeryun_fail.wav\")\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_UPGRADE_DISABLE_ITEM)\n\n\t\telif player.REFINE_CANT_REFINE_METIN_TO_EQUIPMENT == result:\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_EQUIP_ITEM)\n\n\t\tif player.REFINE_OK != result:\n\t\t\treturn\n\n\t\tself.refineDialog.Open(scrollSlotPos, targetSlotPos)\n\n\tdef DetachMetinFromItem(self, scrollSlotPos, targetSlotPos):\n\t\tscrollIndex = player.GetItemIndex(scrollSlotPos)\n\t\ttargetIndex = player.GetItemIndex(targetSlotPos)\n\n\t\tif not player.CanDetach(scrollIndex, targetSlotPos):\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_METIN_INSEPARABLE_ITEM)\n\t\t\treturn\n\n\t\tself.questionDialog = uiCommon.QuestionDialog()\n\t\tself.questionDialog.SetText(locale.REFINE_DO_YOU_SEPARATE_METIN)\n\t\tself.questionDialog.SetAcceptEvent(ui.__mem_func__(self.OnDetachMetinFromItem))\n\t\tself.questionDialog.SetCancelEvent(ui.__mem_func__(self.OnCloseQuestionDialog))\n\t\tself.questionDialog.Open()\n\t\tself.questionDialog.sourcePos = scrollSlotPos\n\t\tself.questionDialog.targetPos = targetSlotPos\n\n\tdef AttachMetinToItem(self, metinSlotPos, targetSlotPos):\n\t\tmetinIndex = player.GetItemIndex(metinSlotPos)\n\t\ttargetIndex = player.GetItemIndex(targetSlotPos)\n\n\t\titem.SelectItem(metinIndex)\n\t\titemName = item.GetItemName()\n\n\t\tresult = player.CanAttachMetin(metinIndex, targetSlotPos)\n\n\t\tif player.ATTACH_METIN_NOT_MATCHABLE_ITEM == result:\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_CAN_NOT_ATTACH(itemName))\n\n\t\tif player.ATTACH_METIN_NO_MATCHABLE_SOCKET == result:\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_NO_SOCKET(itemName))\n\n\t\telif player.ATTACH_METIN_NOT_EXIST_GOLD_SOCKET == result:\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_NO_GOLD_SOCKET(itemName))\n\n\t\telif player.ATTACH_METIN_CANT_ATTACH_TO_EQUIPMENT == result:\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.REFINE_FAILURE_EQUIP_ITEM)\n\n\t\tif player.ATTACH_METIN_OK != result:\n\t\t\treturn\n\n\t\tself.attachMetinDialog.Open(metinSlotPos, targetSlotPos)\n\n\n\t\t\n\tdef OverOutItem(self):\n\t\tself.wndItem.SetUsableItem(FALSE)\n\t\tif None != self.tooltipItem:\n\t\t\tself.tooltipItem.HideToolTip()\n\n\tdef OverInItem(self, overSlotPos):\n\t\toverSlotPos = self.__InventoryLocalSlotPosToGlobalSlotPos(overSlotPos)\n\t\tself.wndItem.SetUsableItem(FALSE)\n\n\t\tif mouseModule.mouseController.isAttached():\n\t\t\tattachedItemType = mouseModule.mouseController.GetAttachedType()\n\t\t\tif player.SLOT_TYPE_INVENTORY == attachedItemType:\n\n\t\t\t\tattachedSlotPos = mouseModule.mouseController.GetAttachedSlotNumber()\n\t\t\t\tattachedItemVNum = mouseModule.mouseController.GetAttachedItemIndex()\n\t\t\t\t\n\t\t\t\tif self.__CanUseSrcItemToDstItem(attachedItemVNum, attachedSlotPos, overSlotPos):\n\t\t\t\t\tself.wndItem.SetUsableItem(TRUE)\n\t\t\t\t\tself.__ShowToolTip(overSlotPos)\n\t\t\t\t\treturn\n\t\t\t\t\n\t\tself.__ShowToolTip(overSlotPos)\n\n\n\tdef __IsUsableItemToItem(self, srcItemVNum, srcSlotPos):\n\t\t\"     ?\"\n\n\t\tif item.IsRefineScroll(srcItemVNum):\n\t\t\treturn TRUE\n\t\telif item.IsMetin(srcItemVNum):\n\t\t\treturn TRUE\n\t\telif item.IsDetachScroll(srcItemVNum):\n\t\t\treturn TRUE\n\t\telif item.IsKey(srcItemVNum):\n\t\t\treturn TRUE\n\t\telif (player.GetItemFlags(srcSlotPos) & ITEM_FLAG_APPLICABLE) == ITEM_FLAG_APPLICABLE:\n\t\t\treturn TRUE\n\t\telse:\n\t\t\tif item.GetUseType(srcItemVNum) in self.USE_TYPE_TUPLE:\n\t\t\t\treturn TRUE\n\t\t\t\n\t\treturn FALSE\n\n\tdef __CanUseSrcItemToDstItem(self, srcItemVNum, srcSlotPos, dstSlotPos):\n\t\t\"    ?\"\n\n\t\tif srcSlotPos == dstSlotPos:\n\t\t\treturn FALSE\n\n\t\tif item.IsRefineScroll(srcItemVNum):\n\t\t\tif player.REFINE_OK == player.CanRefine(srcItemVNum, dstSlotPos):\n\t\t\t\treturn TRUE\n\t\telif item.IsMetin(srcItemVNum):\n\t\t\tif player.ATTACH_METIN_OK == player.CanAttachMetin(srcItemVNum, dstSlotPos):\n\t\t\t\treturn TRUE\n\t\telif item.IsDetachScroll(srcItemVNum):\n\t\t\tif player.DETACH_METIN_OK == player.CanDetach(srcItemVNum, dstSlotPos):\n\t\t\t\treturn TRUE\n\t\telif item.IsKey(srcItemVNum):\n\t\t\tif player.CanUnlock(srcItemVNum, dstSlotPos):\n\t\t\t\treturn TRUE\n\n\t\telif (player.GetItemFlags(srcSlotPos) & ITEM_FLAG_APPLICABLE) == ITEM_FLAG_APPLICABLE:\n\t\t\treturn TRUE\n\n\t\telse:\n\t\t\tuseType=item.GetUseType(srcItemVNum)\n\n\t\t\tif \"USE_CLEAN_SOCKET\" == useType:\n\t\t\t\tif self.__CanCleanBrokenMetinStone(dstSlotPos):\n\t\t\t\t\treturn TRUE\n\t\t\telif \"USE_CHANGE_ATTRIBUTE\" == useType:\n\t\t\t\tif self.__CanChangeItemAttrList(dstSlotPos):\n\t\t\t\t\treturn TRUE\n\t\t\telif \"USE_ADD_ATTRIBUTE\" == useType:\n\t\t\t\tif self.__CanAddItemAttr(dstSlotPos):\n\t\t\t\t\treturn TRUE\n\t\t\telif \"USE_ADD_ATTRIBUTE2\" == useType:\n\t\t\t\tif self.__CanAddItemAttr(dstSlotPos):\n\t\t\t\t\treturn TRUE\n\t\t\telif \"USE_ADD_ACCESSORY_SOCKET\" == useType:\n\t\t\t\tif self.__CanAddAccessorySocket(dstSlotPos):\n\t\t\t\t\treturn TRUE\n\t\t\telif \"USE_PUT_INTO_ACCESSORY_SOCKET\" == useType:\t\t\t\t\t\t\t\t\n\t\t\t\tif self.__CanPutAccessorySocket(dstSlotPos, srcItemVNum):\n\t\t\t\t\treturn TRUE;\n\n\t\treturn FALSE\n\n\tdef __CanCleanBrokenMetinStone(self, dstSlotPos):\n\t\tdstItemVNum = player.GetItemIndex(dstSlotPos)\n\t\tif dstItemVNum == 0:\n\t\t\treturn FALSE\n\n\t\titem.SelectItem(dstItemVNum)\n\t\t\n\t\tif item.ITEM_TYPE_WEAPON != item.GetItemType():\n\t\t\treturn FALSE\n\n\t\tfor i in xrange(player.METIN_SOCKET_MAX_NUM):\n\t\t\tif player.GetItemMetinSocket(dstSlotPos, i) == constInfo.ERROR_METIN_STONE:\n\t\t\t\treturn TRUE\n\n\t\treturn FALSE\n\n\tdef __CanChangeItemAttrList(self, dstSlotPos):\n\t\tdstItemVNum = player.GetItemIndex(dstSlotPos)\n\t\tif dstItemVNum == 0:\n\t\t\treturn FALSE\n\n\t\titem.SelectItem(dstItemVNum)\n\t\t\n\t\tif not item.GetItemType() in (item.ITEM_TYPE_WEAPON, item.ITEM_TYPE_ARMOR):\t \n\t\t\treturn FALSE\n\n\t\tfor i in xrange(player.METIN_SOCKET_MAX_NUM):\n\t\t\tif player.GetItemAttribute(dstSlotPos, i) != 0:\n\t\t\t\treturn TRUE\n\n\t\treturn FALSE\n\n\tdef __CanPutAccessorySocket(self, dstSlotPos, mtrlVnum):\n\t\tdstItemVNum = player.GetItemIndex(dstSlotPos)\n\t\tif dstItemVNum == 0:\n\t\t\treturn FALSE\n\n\t\titem.SelectItem(dstItemVNum)\n\n\t\tif item.GetItemType() != item.ITEM_TYPE_ARMOR:\n\t\t\treturn FALSE\n\n\t\tif not item.GetItemSubType() in (item.ARMOR_WRIST, item.ARMOR_NECK, item.ARMOR_EAR):\n\t\t\treturn FALSE\n\n\t\tcurCount = player.GetItemMetinSocket(dstSlotPos, 0)\n\t\tmaxCount = player.GetItemMetinSocket(dstSlotPos, 1)\n\n\t\tif mtrlVnum != constInfo.GET_ACCESSORY_MATERIAL_VNUM(dstItemVNum, item.GetItemSubType()):\n\t\t\treturn FALSE\n\t\t\n\t\tif curCount>=maxCount:\n\t\t\treturn FALSE\n\n\t\treturn TRUE\n\n\tdef __CanAddAccessorySocket(self, dstSlotPos):\n\t\tdstItemVNum = player.GetItemIndex(dstSlotPos)\n\t\tif dstItemVNum == 0:\n\t\t\treturn FALSE\n\n\t\titem.SelectItem(dstItemVNum)\n\n\t\tif item.GetItemType() != item.ITEM_TYPE_ARMOR:\n\t\t\treturn FALSE\n\n\t\tif not item.GetItemSubType() in (item.ARMOR_WRIST, item.ARMOR_NECK, item.ARMOR_EAR):\n\t\t\treturn FALSE\n\n\t\tcurCount = player.GetItemMetinSocket(dstSlotPos, 0)\n\t\tmaxCount = player.GetItemMetinSocket(dstSlotPos, 1)\n\t\t\n\t\tACCESSORY_SOCKET_MAX_SIZE = 3\n\t\tif maxCount >= ACCESSORY_SOCKET_MAX_SIZE:\n\t\t\treturn FALSE\n\n\t\treturn TRUE\n\n\tdef __CanAddItemAttr(self, dstSlotPos):\n\t\tdstItemVNum = player.GetItemIndex(dstSlotPos)\n\t\tif dstItemVNum == 0:\n\t\t\treturn FALSE\n\n\t\titem.SelectItem(dstItemVNum)\n\t\t\n\t\tif not item.GetItemType() in (item.ITEM_TYPE_WEAPON, item.ITEM_TYPE_ARMOR):\t \n\t\t\treturn FALSE\n\t\t\t\n\t\tattrCount = 0\n\t\tfor i in xrange(player.METIN_SOCKET_MAX_NUM):\n\t\t\tif player.GetItemAttribute(dstSlotPos, i) != 0:\n\t\t\t\tattrCount += 1\n\n\t\tif attrCount<4:\n\t\t\treturn TRUE\n\t\t\t\t\t\t\t\t\n\t\treturn FALSE\n\n\tdef __ShowToolTip(self, slotIndex):\n\t\tif None != self.tooltipItem:\n\t\t\tself.tooltipItem.SetInventoryItem(slotIndex)\n\n\tdef OnTop(self):\n\t\tif None != self.tooltipItem:\n\t\t\tself.tooltipItem.SetTop()\n\n\tdef OnPressEscapeKey(self):\n\t\tself.Close()\n\t\treturn TRUE\n\n\tdef UseItemSlot(self, slotIndex):\n\n\t\tslotIndex = self.__InventoryLocalSlotPosToGlobalSlotPos(slotIndex)\n\n\t\tself.__UseItem(slotIndex)\n\t\tmouseModule.mouseController.DeattachObject()\n\t\tself.OverOutItem()\n\n\tdef __UseItem(self, slotIndex):\n\t\tItemVNum = player.GetItemIndex(slotIndex)\n\t\titem.SelectItem(ItemVNum)\n\t\tif item.IsFlag(item.ITEM_FLAG_CONFIRM_WHEN_USE):\n\t\t\tself.questionDialog = uiCommon.QuestionDialog()\n\t\t\tself.questionDialog.SetText(locale.INVENTORY_REALLY_USE_ITEM)\n\t\t\tself.questionDialog.SetAcceptEvent(ui.__mem_func__(self.__UseItemQuestionDialog_OnAccept))\n\t\t\tself.questionDialog.SetCancelEvent(ui.__mem_func__(self.__UseItemQuestionDialog_OnCancel))\n\t\t\tself.questionDialog.Open()\n\t\t\tself.questionDialog.slotIndex = slotIndex\n\n\t\telse:\n\t\t\tself.__SendUseItemPacket(slotIndex)\n\t\t\t#net.SendItemUsePacket(slotIndex)\t\n\n\tdef __UseItemQuestionDialog_OnCancel(self):\n\t\tself.OnCloseQuestionDialog()\n\n\tdef __UseItemQuestionDialog_OnAccept(self):\n\t\tself.__SendUseItemPacket(self.questionDialog.slotIndex)\n\n\t\tif self.questionDialog:\n\t\t\tself.questionDialog.Close()\n\t\tself.questionDialog = None\n\n\tdef __SendUseItemToItemPacket(self, srcSlotPos, dstSlotPos):\n\t\t#       \n\t\tif uiPrivateShopBuilder.IsBuildingPrivateShop():\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.USE_ITEM_FAILURE_PRIVATE_SHOP)\n\t\t\treturn\n\n\t\tnet.SendItemUseToItemPacket(srcSlotPos, dstSlotPos)\n\n\tdef __SendUseItemPacket(self, slotPos):\n\t\t#       \n\t\tif uiPrivateShopBuilder.IsBuildingPrivateShop():\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.USE_ITEM_FAILURE_PRIVATE_SHOP)\n\t\t\treturn\n\n\t\tnet.SendItemUsePacket(slotPos)\n\t\n\tdef __SendMoveItemPacket(self, srcSlotPos, dstSlotPos, srcItemCount):\n\t\t#       \n\t\tif uiPrivateShopBuilder.IsBuildingPrivateShop():\n\t\t\tchat.AppendChat(chat.CHAT_TYPE_INFO, locale.MOVE_ITEM_FAILURE_PRIVATE_SHOP)\n\t\t\treturn\n\n\t\tnet.SendItemMovePacket(srcSlotPos, dstSlotPos, srcItemCount)",
 "title": ""
}